<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Fast Billing & Receipt</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Lighter background */
        }

        /* Custom styles for the 75mm thermal receipt simulation */
        #receipt-print-area {
            max-width: 75mm; /* Approx 283px */
            width: 283px; /* Fixed width for non-print view */
            margin: 0 auto;
            padding: 10px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 11px;
            line-height: 1.2;
            background-color: white;
            color: #1f2937;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #receipt-print-area, #receipt-print-area * {
                visibility: visible;
            }
            #receipt-print-area {
                position: absolute;
                left: 0;
                top: 0;
                max-width: 75mm;
                width: 75mm;
                padding: 0;
                margin: 0;
                box-shadow: none;
            }
            .no-print {
                display: none !important;
            }
        }
        /* Style for quantity buttons to ensure visibility */
        .qty-btn {
            line-height: 1; /* Fix vertical alignment */
        }
        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
    <!-- Load QR Code Generator CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Load HTML to PDF Library CDN (Removed usage, kept for reference) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="p-4 md:p-8">

    <!-- NAVIGATION BUTTONS -->
    <div class="fixed top-4 right-4 z-10 no-print flex space-x-2">
        <button id="toggle-view-btn" class="py-2 px-4 bg-gray-700 text-white font-semibold rounded-lg shadow-xl hover:bg-gray-800 transition duration-150 transform">
            View Receipts History
        </button>
        <button id="manage-menu-btn" class="py-2 px-4 bg-amber-600 text-white font-semibold rounded-lg shadow-xl hover:bg-amber-700 transition duration-150 transform">
            Manage Menu
        </button>
    </div>

    <!-- POS VIEW -->
    <div id="pos-view" class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Billing Area / Menu List (Col 1 & 2) -->
        <div class="lg:col-span-2 p-6 bg-white rounded-2xl shadow-xl border border-gray-100 no-print">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b-4 border-amber-500 pb-2">
                Nalan's Cafe Digital POS
            </h1>
            <p class="text-gray-500 mb-6">Tap to add items to the customer's bill.</p>

            <!-- Location Selector (New) -->
            <div class="mb-6 p-4 bg-yellow-50 rounded-lg shadow-inner border border-yellow-200">
                <label for="location-select" class="block text-lg font-semibold text-gray-700 mb-2">Current Location</label>
                <select id="location-select" class="w-full p-2 border rounded-lg focus:ring-amber-500 focus:border-amber-500 bg-white">
                    <!-- Options injected by JavaScript -->
                </select>
            </div>
            <!-- End Location Selector -->

            <!-- Menu List: Line-wise display -->
            <div id="menu-list" class="flex flex-col space-y-2">
                <!-- Menu items will be injected here (now styled as list rows) -->
            </div>

            <button id="clear-cart-btn" class="mt-8 w-full py-3 bg-red-500 text-white font-semibold rounded-xl shadow-lg hover:bg-red-600 transition duration-150 transform hover:scale-[1.005]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                </svg>
                Clear Entire Bill
            </button>
        </div>

        <!-- Receipt Preview / Cart Summary (Col 3) -->
        <div class="lg:col-span-1 p-6 bg-white rounded-2xl shadow-xl border border-gray-100 flex flex-col items-center sticky top-4 h-fit">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-gray-200 w-full pb-2 text-center">
                Order Summary
            </h2>

            <!-- Cart Table -->
            <div class="w-full mb-6 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 rounded-t-lg">
                        <tr>
                            <th class="px-2 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Item</th>
                            <th class="px-2 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Qty</th>
                            <th class="px-2 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Amt (₹)</th>
                        </tr>
                    </thead>
                    <tbody id="cart-table-body" class="bg-white divide-y divide-gray-100">
                        <!-- Cart rows will be injected here -->
                        <tr id="empty-cart-message">
                            <td colspan="3" class="px-2 py-6 whitespace-nowrap text-sm text-gray-400 text-center italic">
                                Cart is empty. Select an item.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Total -->
            <div class="w-full flex justify-between items-center text-2xl font-extrabold border-t-2 border-teal-500 pt-4 mt-2">
                <span>TOTAL PAYABLE:</span>
                <span id="cart-total" class="text-teal-600">₹ 0</span>
            </div>

            <button id="generate-receipt-btn" disabled class="mt-6 w-full py-4 bg-teal-600 text-white font-extrabold text-xl rounded-xl shadow-2xl shadow-teal-300 hover:bg-teal-700 transition duration-300 disabled:bg-gray-400 disabled:shadow-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v2" />
                </svg>
                FINISH, PRINT & SHARE
            </button>
            
            <!-- Receipt Display (Hidden by default, shown/styled on print) -->
            <div id="receipt-container" class="mt-8 p-4 bg-gray-100 rounded-lg w-full hidden flex-col items-center border border-gray-300">
                <h3 class="text-lg font-bold mb-2 text-gray-700">Receipt Print Preview</h3>
                <div id="receipt-print-area" class="border-2 border-dashed border-gray-400">
                    <!-- Receipt Content will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- HISTORY VIEW (Hidden by default) -->
    <div id="history-view" class="max-w-7xl mx-auto hidden">
        <div class="p-6 bg-white rounded-2xl shadow-xl border border-gray-100">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b-4 border-teal-500 pb-2 flex justify-between items-center">
                Receipts History
                <span class="text-base text-gray-500 font-semibold">Nalan's Cafe</span>
            </h1>

            <!-- Filter Controls -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="col-span-1 md:col-span-2">
                    <label for="date-filter" class="block text-sm font-medium text-gray-700">Filter by Date</label>
                    <input type="date" id="date-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2 border">
                </div>
                
                <!-- Month Filter Dropdown -->
                <div class="col-span-1">
                    <label for="month-filter" class="block text-sm font-medium text-gray-700">Filter by Month</label>
                    <select id="month-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2 border bg-white">
                        <option value="">Select Month</option>
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                
                <div class="col-span-1 flex items-end space-x-2">
                    <button id="reset-filter-btn" class="w-1/2 py-2 px-3 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-150">Reset</button>
                    <button id="download-csv-btn" class="w-1/2 py-2 px-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-150">
                        Download CSV
                    </button>
                </div>
            </div>


            <div class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Time</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Invoice No.</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600 uppercase tracking-wider">Total (₹)</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="bg-white divide-y divide-gray-100">
                        <!-- History rows will be dynamically loaded here -->
                    </tbody>
                </table>
            </div>

            <p id="history-empty-message" class="text-center py-8 text-gray-500 italic hidden">
                No receipts found in history. Start a new bill!
            </p>

            <!-- Filtered Total -->
            <div class="w-full flex justify-end items-center text-xl font-extrabold border-t-4 border-gray-200 pt-4 mt-4">
                <span class="mr-4">FILTERED TOTAL:</span>
                <span id="filtered-total" class="text-teal-600">₹ 0</span>
            </div>
        </div>
    </div>
    
    <!-- MENU ADMIN VIEW (Hidden by default) -->
    <div id="menu-admin-view" class="max-w-7xl mx-auto hidden">
        <div class="p-6 bg-white rounded-2xl shadow-xl border border-gray-100">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b-4 border-amber-500 pb-2">
                Menu and Location Management
            </h1>
            
            <!-- Location Management Section (New) -->
            <div class="mb-8 p-4 bg-blue-50 rounded-lg shadow-inner border border-blue-200">
                <h2 class="text-xl font-semibold mb-3 text-gray-700">Manage Locations</h2>
                <div class="flex flex-col space-y-4">
                    <!-- Add New Location Form -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="new-location-name" placeholder="Location Name (e.g., Koramangala)" class="p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 col-span-1">
                        <input type="text" id="new-location-address" placeholder="Address on Receipt (e.g., Koramangala, Bangalore)" class="p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 col-span-1">
                        <button id="add-location-btn" class="py-2 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition col-span-1">Add Location</button>
                    </div>

                    <!-- Current Locations List -->
                    <table class="min-w-full divide-y divide-gray-200 mt-4">
                        <thead class="bg-blue-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Name</th>
                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Address</th>
                                <th class="px-4 py-2 text-center text-sm font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-location-table-body" class="bg-white divide-y divide-gray-100">
                            <!-- Location rows injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- End Location Management Section -->

            <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b-4 border-amber-500 pb-2">
                Menu Management
            </h1>
            <!-- Add New Item Form -->
            <div class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold mb-3 text-gray-700">Add New Item</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="new-item-name" placeholder="Item Name (e.g., Idli)" class="p-2 border rounded-lg focus:ring-amber-500 focus:border-amber-500">
                    <input type="number" id="new-item-price" placeholder="Price (₹)" class="p-2 border rounded-lg focus:ring-amber-500 focus:border-amber-500" min="1">
                    <button id="add-item-btn" class="py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600 transition">Add Item</button>
                </div>
            </div>

            <!-- Current Menu List for Editing -->
            <h2 class="text-xl font-semibold mb-3 text-gray-700">Current Menu Items</h2>
            <div class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Item Name</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Price (₹)</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-menu-table-body" class="bg-white divide-y divide-gray-100">
                        <!-- Admin menu rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ADMIN LOGIN MODAL (Hidden by default) -->
    <div id="admin-login-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm transform transition-transform duration-300 ease-out">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Admin Login</h3>
            <p class="text-sm text-gray-600 mb-4">Enter the static password to manage the menu.</p>
            <input type="password" id="admin-password-input" placeholder="Enter Password" class="w-full p-3 border rounded-lg mb-4 focus:ring-amber-500 focus:border-amber-500">
            <p id="auth-error-message" class="text-red-500 text-sm mb-4 hidden">Incorrect password.</p>
            <button id="login-admin-btn" class="w-full py-3 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600 transition">Login</button>
            <button onclick="document.getElementById('admin-login-modal').classList.add('hidden')" class="mt-4 w-full py-2 text-gray-600 font-semibold rounded-lg hover:bg-gray-100 transition">Cancel</button>
        </div>
    </div>
    
    <!-- WHATSAPP SHARE MODAL (Hidden by default) -->
    <div id="whatsapp-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm transform transition-transform duration-300 ease-out">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                <span class="text-green-500 mr-2">✓</span> Share Bill Summary
            </h3>
            <p id="modal-status-text" class="text-gray-700 mb-4 font-semibold">
                The bill has been finalized and a text summary is ready to send.
            </p>
            <p id="modal-info-text" class="text-sm text-gray-500 mb-6">
                The printed receipt is complete. Share the text summary with the customer via WhatsApp.
            </p>

            <a id="whatsapp-link" href="#" target="_blank" class="w-full inline-flex items-center justify-center py-3 px-4 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition duration-150 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="mr-2"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.911C.153 5.529 6.273.023 13.911.023 19.349.023 24 4.14 24 9.444s-5.642 9.444-11.08 9.444c-1.789 0-3.56-.484-5.06-1.47l-5.694 1.859zm8.572-3.286c1.196.577 2.45 1.05 3.737 1.05 6.007 0 10.875-4.814 10.875-10.749S19.92 1.444 13.913 1.444c-5.992 0-10.86 4.757-10.86 10.693 0 2.053.585 3.996 1.764 5.656l.462.658-1.571 5.751 6.088-1.996zM18.84 14.168c-.144-.072-.867-.428-1-.477s-.26-.072-.375.144c-.116.216-.448.577-.547.689-.1.116-.219.125-.407.05s-.764-.282-1.45-8.91c-.024-.09-.005-.152.01-.214.015-.062.032-.14.076-.214.045-.074.148-.19.223-.33.076-.144.153-.26.23-.385.076-.125.045-.236-.007-.33s-.4-.959-.553-1.314c-.152-.355-.316-.305-.448-.c-.131-.005-.282-.005-.433-.005s-.383-.005-.589.294c-.19.289-.731.724-.897.876-.166.152-.353.477-.547.729-.194.252-.375.589-.547.794-.173.206-.345.214-.64.072-.295-.144-1.258-.466-2.4-.775-.92-.25-1.5-.412-1.9-.45-.4-.04-.73-.02-.998.375-.26.395-.733.957-.899 1.152-.166.194-.336.214-.619.072-.282-.144-.732-.26-.782-.284-.05-.024-.108-.028-.219-.028-.116 0-.306.05-.46.223-.153.173-.559.553-.611.664-.052.116-.108.23-.05.347s.944 2.894 2.049 4.394 2.373 1.636 2.823 1.946c.45.31 1.25.597 1.699.424 2.358-1.077 3.518-2.614 3.73-2.77s.213-.274.152-.426z"/></svg>
                Open WhatsApp
            </a>
            <button onclick="document.getElementById('whatsapp-modal').classList.add('hidden')" class="mt-4 w-full py-2 text-gray-600 font-semibold rounded-lg hover:bg-gray-100 transition">Cancel</button>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // Global variables for Firebase compatibility (required by environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- GLOBAL CONSTANTS ---
        const HOTEL_NAME = "Nalan's Cafe";
        const UPI_PAYEE_NAME = "Nalan Cafe";
        // const HOTEL_ADDRESS is now dynamic
        const FSSAI_NO = "10021000000123";
        const UPI_ID = "keepr@upi";
        const ADMIN_PASSWORD = "admin@123";
        
        // --- STORAGE KEYS ---
        const INVOICE_KEY = 'nalanCafeInvoiceCounter';
        const HISTORY_KEY = 'nalanCafeReceiptHistory';
        const MENU_KEY = 'nalanCafeMenu';
        const LOCATION_KEY = 'nalanCafeLocations'; // New Key for Locations
        const CURRENT_LOCATION_ID_KEY = 'nalanCafeCurrentLocationId'; // New Key for current location selection
        const INVOICE_PREFIX = 'INV-';

        // --- DEFAULT DATA ---
        const defaultMenuItems = [
            { id: 'dosa', name: "Masala Dosa", price: 40 },
            { id: 'rice', name: "Rice Bath", price: 50 },
            { id: 'meals', name: "Meals", price: 70 },
            { id: 'vada', name: "Vada", price: 20 },
            { id: 'tea', name: "Tea", price: 15 },
            { id: 'coffee', name: "Filter Coffee", price: 20 },
        ];
        
        const defaultLocations = [
             { id: 'yeshwanthpur', name: 'Yeshwanthpur', address: 'Yeshwanthpur - Bangalore' },
             { id: 'yelahanka', name: 'Yelahanka', address: 'Yelahanka - Bangalore' },
        ];
        
        // --- STATE & ELEMENTS ---
        let cart = {}; // Current cart state
        let menuItems = []; // Global menu state
        let locations = []; // Global locations state
        let currentLocationId = null; // Currently selected location ID

        const menuList = document.getElementById('menu-list');
        const cartTableBody = document.getElementById('cart-table-body');
        const cartTotalDisplay = document.getElementById('cart-total');
        const emptyMessage = document.getElementById('empty-cart-message');
        const generateReceiptBtn = document.getElementById('generate-receipt-btn');
        const clearCartBtn = document.getElementById('clear-cart-btn');
        const receiptPrintArea = document.getElementById('receipt-print-area');
        const whatsappModal = document.getElementById('whatsapp-modal');
        const whatsappLink = document.getElementById('whatsapp-link');
        const modalStatusText = document.getElementById('modal-status-text');
        const modalInfoText = document.getElementById('modal-info-text');
        const posView = document.getElementById('pos-view');
        const historyView = document.getElementById('history-view');
        const menuAdminView = document.getElementById('menu-admin-view');
        const toggleViewBtn = document.getElementById('toggle-view-btn');
        const historyTableBody = document.getElementById('history-table-body');
        const historyEmptyMessage = document.getElementById('history-empty-message');
        const filteredTotalDisplay = document.getElementById('filtered-total');
        const dateFilter = document.getElementById('date-filter');
        const monthFilter = document.getElementById('month-filter');
        const resetFilterBtn = document.getElementById('reset-filter-btn');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const manageMenuBtn = document.getElementById('manage-menu-btn');
        const adminLoginModal = document.getElementById('admin-login-modal');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const loginAdminBtn = document.getElementById('login-admin-btn');
        const authErrorMessage = document.getElementById('auth-error-message');
        const adminMenuTableBody = document.getElementById('admin-menu-table-body');
        const newItemNameInput = document.getElementById('new-item-name');
        const newItemPriceInput = document.getElementById('new-item-price');
        const addItemBtn = document.getElementById('add-item-btn');
        
        // New Location Elements
        const locationSelect = document.getElementById('location-select');
        const newLocationNameInput = document.getElementById('new-location-name');
        const newLocationAddressInput = document.getElementById('new-location-address');
        const addLocationBtn = document.getElementById('add-location-btn');
        const adminLocationTableBody = document.getElementById('admin-location-table-body');


        // --- DATA LOAD/SAVE FUNCTIONS ---

        function loadLocations() {
             try {
                const storedLocations = localStorage.getItem(LOCATION_KEY);
                locations = storedLocations ? JSON.parse(storedLocations) : defaultLocations;
                currentLocationId = localStorage.getItem(CURRENT_LOCATION_ID_KEY) || (locations.length > 0 ? locations[0].id : null);
            } catch (e) {
                console.error("Error loading locations:", e);
                locations = defaultLocations;
            }
        }
        
        function saveLocations() {
            localStorage.setItem(LOCATION_KEY, JSON.stringify(locations));
            localStorage.setItem(CURRENT_LOCATION_ID_KEY, currentLocationId);
            renderLocationSelector();
        }

        function loadMenuItems() {
            try {
                const storedMenu = localStorage.getItem(MENU_KEY);
                menuItems = storedMenu ? JSON.parse(storedMenu) : defaultMenuItems;
            } catch (e) {
                console.error("Error loading menu items:", e);
                menuItems = defaultMenuItems;
            }
        }

        function saveMenuItems() {
            localStorage.setItem(MENU_KEY, JSON.stringify(menuItems));
            initMenu(); // Re-render POS menu after save
        }
        
        function loadReceipts() {
            try {
                const history = localStorage.getItem(HISTORY_KEY);
                return history ? JSON.parse(history) : [];
            } catch (e) {
                console.error("Error loading receipt history:", e);
                return [];
            }
        }

        function saveReceipt(receiptData) {
            const history = loadReceipts();
            history.push(receiptData);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }


        // --- LOCATION ADMIN/POS LOGIC ---
        
        function renderLocationSelector() {
            locationSelect.innerHTML = '';
            
            if (locations.length === 0) {
                 locationSelect.innerHTML = '<option value="">--- No Locations Defined ---</option>';
                 currentLocationId = null;
                 return;
            }

            locations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.id;
                option.textContent = loc.name;
                if (loc.id === currentLocationId) {
                    option.selected = true;
                }
                locationSelect.appendChild(option);
            });
            
            // Set the current ID if it was null or invalid
            if (!currentLocationId || !locations.find(loc => loc.id === currentLocationId)) {
                currentLocationId = locations.length > 0 ? locations[0].id : null;
                localStorage.setItem(CURRENT_LOCATION_ID_KEY, currentLocationId);
            }
            
            // Add a disabled/default option if needed
             if (!currentLocationId) {
                 locationSelect.insertAdjacentHTML('afterbegin', '<option value="" disabled selected>Select a Location</option>');
             }
        }
        
        function handleLocationChange(event) {
            currentLocationId = event.target.value;
            localStorage.setItem(CURRENT_LOCATION_ID_KEY, currentLocationId);
        }

        function renderAdminLocations() {
            adminLocationTableBody.innerHTML = '';
            
            locations.forEach(loc => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-blue-50 transition duration-100';
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${loc.name}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${loc.address}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-center">
                        <button data-id="${loc.id}" data-action="delete-loc" class="text-red-600 hover:text-red-800 font-semibold p-2 rounded-full hover:bg-red-100 transition">Delete</button>
                    </td>
                `;
                adminLocationTableBody.appendChild(row);
            });
            
            adminLocationTableBody.querySelectorAll('button[data-action="delete-loc"]').forEach(button => {
                button.addEventListener('click', deleteLocation);
            });
        }
        
        function addLocation() {
            const name = newLocationNameInput.value.trim();
            const address = newLocationAddressInput.value.trim();
            
            if (name && address) {
                const newId = name.toLowerCase().replace(/\s+/g, '-');
                if (locations.some(loc => loc.id === newId)) {
                    alert('Location name already exists. Please choose a different name.');
                    return;
                }
                locations.push({ id: newId, name: name, address: address });
                saveLocations();
                renderAdminLocations();
                newLocationNameInput.value = '';
                newLocationAddressInput.value = '';
            } else {
                alert('Please enter both location name and address.');
            }
        }
        
        function deleteLocation(event) {
            const locationId = event.target.dataset.id;
            if (locations.length <= 1) {
                alert('Cannot delete the last remaining location.');
                return;
            }
            const confirmation = window.confirm(`Are you sure you want to delete location: ${locationId}?`);
            if (confirmation) {
                locations = locations.filter(loc => loc.id !== locationId);
                
                // If the deleted location was the currently selected one, default to the first remaining location
                if (currentLocationId === locationId) {
                    currentLocationId = locations.length > 0 ? locations[0].id : null;
                }
                
                saveLocations();
                renderAdminLocations();
                updateCart(); 
            }
        }


        // --- MENU ADMIN LOGIC ---

        function showAdminLogin() {
            adminPasswordInput.value = '';
            authErrorMessage.classList.add('hidden');
            adminLoginModal.classList.remove('hidden');
            adminLoginModal.classList.add('flex');
        }

        function authenticateAdmin() {
            const enteredPassword = adminPasswordInput.value;
            if (enteredPassword === ADMIN_PASSWORD) {
                adminLoginModal.classList.add('hidden');
                showView('admin');
                renderAdminMenu();
                renderAdminLocations();
            } else {
                authErrorMessage.classList.remove('hidden');
                setTimeout(() => authErrorMessage.classList.add('hidden'), 3000);
            }
        }
        
        function renderAdminMenu() {
            adminMenuTableBody.innerHTML = '';
            
            menuItems.sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-100';
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                        <input type="text" value="${item.name}" data-id="${item.id}" data-field="name" 
                               class="w-full border-none p-1 rounded-md bg-transparent hover:bg-gray-100" />
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-right">
                        <input type="number" value="${item.price}" data-id="${item.id}" data-field="price" 
                               class="w-20 text-right border-none p-1 rounded-md bg-transparent hover:bg-gray-100 focus:bg-white" min="1" />
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-center">
                        <button data-id="${item.id}" data-action="delete" class="text-red-600 hover:text-red-800 font-semibold p-2 rounded-full hover:bg-red-100 transition">Delete</button>
                    </td>
                `;
                adminMenuTableBody.appendChild(row);
            });
            
            // Attach listeners for updates and deletes after rendering
            adminMenuTableBody.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', handleAdminItemUpdate);
            });
            adminMenuTableBody.querySelectorAll('button[data-action="delete"]').forEach(button => {
                button.addEventListener('click', deleteMenuItem);
            });
        }
        
        function handleAdminItemUpdate(event) {
            const input = event.target;
            const itemId = input.dataset.id;
            const field = input.dataset.field;
            let value = input.value;
            
            let itemIndex = menuItems.findIndex(item => item.id === itemId);
            if (itemIndex > -1) {
                if (field === 'price') {
                    value = parseFloat(value) || 0;
                }
                menuItems[itemIndex][field] = value;
                saveMenuItems();
            }
        }
        
        function addMenuItem() {
            const name = newItemNameInput.value.trim();
            const price = parseFloat(newItemPriceInput.value);
            
            if (name && price > 0) {
                // Simple ID generation (time-based)
                const newId = 'item-' + Date.now();
                menuItems.push({ id: newId, name: name, price: price });
                saveMenuItems();
                renderAdminMenu(); // Re-render admin list
                newItemNameInput.value = '';
                newItemPriceInput.value = '';
            } else {
                alert('Please enter a valid name and price greater than 0.');
            }
        }
        
        function deleteMenuItem(event) {
            const itemId = event.target.dataset.id;
            const confirmation = window.confirm(`Are you sure you want to delete item ID: ${itemId}?`);
            if (confirmation) {
                menuItems = menuItems.filter(item => item.id !== itemId);
                saveMenuItems();
                renderAdminMenu(); // Re-render admin list
                updateCart(); // Ensure POS cart removes any deleted item
            }
        }


        // --- POS & CART LOGIC ---
        
        function getNextInvoiceNumber(increment = true) {
            let counter = parseInt(localStorage.getItem(INVOICE_KEY)) || 1001; 
            const invoiceNumber = INVOICE_PREFIX + String(counter).padStart(4, '0');
            if (increment) {
                localStorage.setItem(INVOICE_KEY, counter + 1);
            }
            return invoiceNumber;
        }
        
        function updateCart() {
            let total = 0;
            
            // Clear existing rows
            cartTableBody.innerHTML = '';

            // Filter cart to only include items still existing in the current menu
            Object.keys(cart).forEach(id => {
                if (!menuItems.some(item => item.id === id)) {
                    delete cart[id];
                }
            });

            const cartItems = Object.values(cart).sort((a, b) => a.name.localeCompare(b.name));

            if (cartItems.length === 0) {
                emptyMessage.style.display = 'table-row';
                generateReceiptBtn.disabled = true;
                total = 0;
            } else {
                emptyMessage.style.display = 'none';
                generateReceiptBtn.disabled = false;
            }

            // Populate cart table
            cartItems.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;

                const row = document.createElement('tr');
                row.className = 'text-gray-700 hover:bg-gray-50 transition duration-100';
                row.innerHTML = `
                    <td class="px-2 py-3 whitespace-nowrap text-sm font-medium">${item.name}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-center text-sm">
                        <div class="flex items-center justify-center space-x-2">
                            <button data-id="${item.id}" data-action="decrease" class="qty-btn text-red-500 hover:text-red-700 font-bold text-lg w-5 h-5 rounded-full border border-red-300 flex items-center justify-center transition">-</button>
                            <span class="font-bold text-gray-800">${item.quantity}</span>
                            <button data-id="${item.id}" data-action="increase" class="qty-btn text-teal-600 hover:text-teal-800 font-bold text-lg w-5 h-5 rounded-full border border-teal-300 flex items-center justify-center transition">+</button>
                        </div>
                    </td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-right font-semibold">₹ ${itemTotal.toFixed(0)}</td>
                `;
                cartTableBody.appendChild(row);
            });

            cartTotalDisplay.textContent = `₹ ${total.toFixed(0)}`;
        }

        function addItemToCart(menuItem) {
            if (cart[menuItem.id]) {
                cart[menuItem.id].quantity += 1;
            } else {
                // Ensure cart item properties are fresh, especially price/name
                cart[menuItem.id] = { 
                    id: menuItem.id, 
                    name: menuItem.name, 
                    price: menuItem.price, 
                    quantity: 1 
                };
            }
            updateCart();
        }

        function handleCartAdjustment(event) {
            const button = event.target.closest('button[data-action]');
            if (!button) return;

            const itemId = button.dataset.id;
            const action = button.dataset.action;

            if (!cart[itemId]) return;

            if (action === 'increase') {
                cart[itemId].quantity += 1;
            } else if (action === 'decrease') {
                cart[itemId].quantity -= 1;
                if (cart[itemId].quantity <= 0) {
                    delete cart[itemId];
                }
            }
            updateCart();
        }

        function clearCart() {
            if (Object.keys(cart).length === 0) return;
            const isConfirmed = window.confirm('Are you sure you want to clear the entire bill?'); 
            if (isConfirmed) {
                cart = {};
                updateCart();
                document.getElementById('receipt-container').classList.add('hidden');
                console.log("Cart cleared.");
            }
        }
        
        // --- HISTORY RENDERING ---

        function renderHistory() {
            const allReceipts = loadReceipts();
            const dateFilterValue = dateFilter.value;
            const monthFilterValue = monthFilter.value; // Get new month value
            
            let filteredReceipts = allReceipts;
            let totalAmount = 0;

            if (dateFilterValue) {
                // Filter by exact date (DD/MM/YYYY format)
                const targetDate = new Date(dateFilterValue).toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                filteredReceipts = filteredReceipts.filter(receipt => receipt.date === targetDate);
            } else if (monthFilterValue) {
                // Filter by month (MM) and assume current year
                const currentYearFull = new Date().getFullYear().toString();
                
                filteredReceipts = filteredReceipts.filter(receipt => {
                    // Extract MM and YYYY from stored DD/MM/YYYY
                    const parts = receipt.date.split('/');
                    if (parts.length < 3) return false;
                    const receiptMonth = parts[1];
                    const receiptYear = parts[2];
                    
                    // Match selected month and current year
                    return receiptMonth === monthFilterValue && receiptYear === currentYearFull;
                });
            }

            historyTableBody.innerHTML = '';

            if (filteredReceipts.length === 0) {
                historyEmptyMessage.classList.remove('hidden');
                filteredTotalDisplay.textContent = '₹ 0';
                return;
            }
            historyEmptyMessage.classList.add('hidden');

            // Sort by latest first
            filteredReceipts.reverse().forEach(receipt => {
                totalAmount += receipt.total;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-100';
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${receipt.date}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${receipt.time}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-teal-600">${receipt.invoiceNumber}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-extrabold text-right">₹ ${receipt.total.toFixed(0)}</td>
                `;
                historyTableBody.appendChild(row);
            });

            filteredTotalDisplay.textContent = `₹ ${totalAmount.toFixed(0)}`;
        }
        
        // --- CSV Download ---
        
        function downloadCSV(data) {
            if (data.length === 0) {
                alert('No data to download for the current filter.');
                return;
            }
            
            const header = ["Date", "Time", "Invoice Number", "Total Amount (₹)"];
            const csvRows = [];
            
            csvRows.push(header.join(','));

            data.forEach(receipt => {
                csvRows.push([
                    `"${receipt.date}"`,
                    `"${receipt.time}"`,
                    `"${receipt.invoiceNumber}"`,
                    receipt.total.toFixed(2)
                ].join(','));
            });

            const csvString = csvRows.join('\n');
            const filename = `Nalan_Cafe_Accounting_Export_${new Date().toISOString().slice(0, 10)}.csv`;
            
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- RECEIPT GENERATION LOGIC ---

        function generateReceiptHTML(total) {
            const items = Object.values(cart);
            const now = new Date();
            
            const fullDate = now.toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const shortDate = now.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
            const time = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
            
            const invoiceNumber = getNextInvoiceNumber();
            
            // Get the dynamically selected address
            const currentAddress = locations.find(loc => loc.id === currentLocationId)?.address || "Unknown Location";

            // Helper to format currency/numbers for the thermal printout
            const formatRs = (amount) => String(amount).padStart(6); 
            const formatQty = (qty) => String(qty).padStart(3); 
            const formatRate = (rate) => String(rate).padStart(5); 

            let itemsList = '';
            items.forEach(item => {
                const itemTotal = item.price * item.quantity;
                const name = item.name.padEnd(16, ' ').substring(0, 16);
                
                itemsList += `<p class="font-mono flex justify-between">
                                <span>${name}</span>
                                <span>${formatQty(item.quantity)} @ ${formatRate(item.price)}</span>
                                <span class="text-right">${formatRs(itemTotal)}</span>
                            </p>`;
            });

            const upiLink = `upi://pay?pa=${UPI_ID}&pn=${encodeURIComponent(UPI_PAYEE_NAME)}&am=${total.toFixed(0)}&cu=INR`;
            
            // Set the HTML content for the receipt print area
            receiptPrintArea.innerHTML = `
                <div class="text-center">
                    <h2 class="text-base font-bold my-1 uppercase tracking-wider">${HOTEL_NAME}</h2>
                    <p class="text-[10px]">${currentAddress}</p>
                    <p class="text-[10px]">FSSAI No: ${FSSAI_NO}</p>
                </div>
                <div class="border-t border-b border-dashed my-2 py-1 flex justify-between text-xs font-mono">
                    <p>Bill No: ${invoiceNumber}</p>
                    <p>Date: ${shortDate}</p>
                </div>
                <div class="border-b border-dashed mb-2 pb-1 flex justify-end text-xs font-mono">
                    <p>Time: ${time}</p>
                </div>

                <div class="flex justify-between font-bold text-xs mb-1 font-mono">
                    <span class="w-1/2">ITEM</span>
                    <span class="text-center" style="width: 100px;">QTY @ RATE</span>
                    <span class="text-right" style="width: 60px;">AMOUNT (₹)</span>
                </div>
                <div class="text-xs">
                    ${itemsList}
                </div>

                <div class="border-t border-dashed mt-2 pt-1 flex justify-end">
                    <div class="w-full text-right font-mono pr-2">
                        <p class="text-sm font-semibold">SUB TOTAL: ₹ ${total.toFixed(2)}</p>
                        <p class="text-lg font-extrabold mt-1 border-t border-dashed pt-1">TOTAL: ₹ ${total.toFixed(0)}</p>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <p class="text-[10px] font-semibold mb-1 text-gray-700 uppercase">Scan to Pay: ₹ ${total.toFixed(0)}</p>
                    <div id="qrcode" class="w-full flex justify-center p-2"></div>
                </div>

                <div class="text-center border-t border-dashed mt-2 pt-2">
                    <p class="text-xs font-bold">THANK YOU, VISIT AGAIN!</p>
                    <p class="text-[8px] mt-1 text-gray-500">Powered by Get Micro</p>
                </div>
            `;

            // Generate QR Code
            const qrCodeDiv = document.getElementById('qrcode');
            qrCodeDiv.innerHTML = '';
            
            new QRCode(qrCodeDiv, {
                text: upiLink,
                width: 100,
                height: 100,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            document.getElementById('receipt-container').classList.remove('hidden');

            return { invoiceNumber, date: fullDate, time: time, total };
        }

        /**
         * Sets up the WhatsApp sharing link and shows the modal with itemized text message.
         */
        function promptWhatsAppShare(total, invoiceNumber, currentCart) {
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-IN');
            const timeStr = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });

            let itemsList = '';
            const cartItems = Object.values(currentCart);
            cartItems.forEach(item => {
                itemsList += `\n* ${item.name} x ${item.quantity} = ₹${(item.price * item.quantity).toFixed(0)}`;
            });

            const rawMessage = 
                `*Nalan's Cafe - Bill Summary*\n\n` +
                `Date: ${dateStr}\n` +
                `Time: ${timeStr}\n` +
                `Invoice No: ${invoiceNumber}\n` +
                `-----------------------------\n` +
                `*Order Details:*${itemsList}\n` +
                `-----------------------------\n` +
                `*Total Amount:* ₹${total.toFixed(0)}`;

            const message = encodeURIComponent(rawMessage);
            
            whatsappLink.href = `https://wa.me/?text=${message}`;

            modalStatusText.textContent = `The bill (₹${total.toFixed(0)}) text summary is ready to send.`;
            modalInfoText.textContent = `The printed receipt is complete. Share the text summary with the customer via WhatsApp.`;

            whatsappModal.classList.remove('hidden');
            whatsappModal.classList.add('flex');
        }


        // --- VIEW MANAGEMENT ---

        function showView(viewId) {
            posView.classList.add('hidden');
            historyView.classList.add('hidden');
            menuAdminView.classList.add('hidden');
            
            if (viewId === 'pos') {
                posView.classList.remove('hidden');
                toggleViewBtn.textContent = 'View Receipts History';
                manageMenuBtn.textContent = 'Manage Menu';
                
            } else if (viewId === 'history') {
                historyView.classList.remove('hidden');
                toggleViewBtn.textContent = 'Back to POS';
                manageMenuBtn.textContent = 'Manage Menu';
                renderHistory();
                
            } else if (viewId === 'admin') {
                menuAdminView.classList.remove('hidden');
                toggleViewBtn.textContent = 'View Receipts History'; // Keep original state
                manageMenuBtn.textContent = 'Back to POS'; 
                renderAdminMenu();
                renderAdminLocations(); // Ensure locations are refreshed
            }
        }
        
        function togglePrimaryView() {
             const currentView = posView.classList.contains('hidden') 
                ? (historyView.classList.contains('hidden') ? 'admin' : 'history') 
                : 'pos';
            
            if (currentView === 'pos' || currentView === 'admin') {
                showView('history');
            } else {
                showView('pos');
            }
        }
        
        function toggleAdminView() {
            const currentView = posView.classList.contains('hidden') 
                ? (historyView.classList.contains('hidden') ? 'admin' : 'history') 
                : 'pos';
            
            if (currentView === 'admin') {
                showView('pos');
            } else {
                showAdminLogin();
            }
        }


        // --- INITIALIZATION ---

        function initMenu() {
            menuList.innerHTML = ''; // Clear previous menu display
            menuItems.forEach(item => {
                const button = document.createElement('button');
                button.className = 'w-full flex items-center justify-between p-4 bg-gray-50 text-gray-800 rounded-lg border border-gray-200 shadow-sm hover:bg-amber-100 transition duration-150 transform hover:shadow-md active:bg-amber-200 focus:outline-none focus:ring-2 focus:ring-amber-500';
                button.setAttribute('data-id', item.id);
                
                button.addEventListener('click', () => addItemToCart(item));
                
                button.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <span class="text-lg font-semibold">${item.name}</span>
                    </div>
                    <span class="text-xl font-extrabold text-teal-600">₹ ${item.price}</span>
                `;
                menuList.appendChild(button);
            });
        }
        
        // --- Event Listeners and Setup ---
        
        // Admin Login Listeners
        loginAdminBtn.addEventListener('click', authenticateAdmin);
        adminPasswordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') authenticateAdmin();
        });
        manageMenuBtn.addEventListener('click', toggleAdminView);
        addItemBtn.addEventListener('click', addMenuItem);
        addLocationBtn.addEventListener('click', addLocation);

        // Primary POS/History Listeners
        cartTableBody.addEventListener('click', handleCartAdjustment);
        clearCartBtn.addEventListener('click', clearCart);
        toggleViewBtn.addEventListener('click', togglePrimaryView);
        locationSelect.addEventListener('change', handleLocationChange);
        
        // Receipt Generation Listener
        generateReceiptBtn.addEventListener('click', () => {
            const selectedLocation = locations.find(loc => loc.id === currentLocationId);
            
            if (!selectedLocation) {
                alert("ERROR: Please select a valid operating location from the dropdown before proceeding.");
                return;
            }

            const total = Object.values(cart).reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const transactionData = generateReceiptHTML(total);
            saveReceipt(transactionData);
            
            window.print();

            setTimeout(() => {
                promptWhatsAppShare(total, transactionData.invoiceNumber, cart);
            }, 100); 
            
            cart = {};
            updateCart();
        });

        // Filter Listeners
        dateFilter.addEventListener('change', () => {
            monthFilter.value = '';
            renderHistory();
        });
        monthFilter.addEventListener('change', () => {
            dateFilter.value = '';
            renderHistory();
        });
        resetFilterBtn.addEventListener('click', () => {
            dateFilter.value = '';
            monthFilter.value = '';
            renderHistory();
        });

        downloadCsvBtn.addEventListener('click', () => {
            const allReceipts = loadReceipts();
            const dateFilterValue = dateFilter.value;
            const monthFilterValue = monthFilter.value;
            
            let dataToExport = allReceipts;

            if (dateFilterValue) {
                const targetDate = new Date(dateFilterValue).toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                dataToExport = dataToExport.filter(receipt => receipt.date === targetDate);
            } else if (monthFilterValue) {
                const currentYearFull = new Date().getFullYear().toString();
                
                dataToExport = dataToExport.filter(receipt => {
                    const parts = receipt.date.split('/');
                    if (parts.length < 3) return false;
                    const receiptMonth = parts[1];
                    const receiptYear = parts[2];
                    
                    return receiptMonth === monthFilterValue && receiptYear === currentYearFull;
                });
            }
            
            downloadCSV(dataToExport.reverse());
        });

        // Initial setup on load
        window.onload = () => {
            loadLocations();
            loadMenuItems();
            renderLocationSelector();
            initMenu();
            updateCart();
            showView('pos'); 
        };
    </script>
</body>
</html>
